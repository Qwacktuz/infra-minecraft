name: Deploy Minecraft
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prd-hel1
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Authenticate with Tailscale
        uses: tailscale/github-action@v4
        with:
          # tailscaled-args: --tun=userspace-networking # TODO/FIXME:WORKS ON MY MACHINE ISSUE? Github runner breaks using this iirc
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Copy Config Files
        uses: appleboy/scp-action@v1
        with:
          host: ${{ vars.TS_HOST }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "./app/"
          target: "/home/${{ vars.USERNAME }}"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1
        env:
          RCON_PASSWORD: ${{ secrets.RCON_PASSWORD }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
          MC_OPS: ${{ secrets.MC_OPS }}
          MC_WHITELIST: ${{ secrets.MC_WHITELIST }}
          # --- R2 ADDITION START ---
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          RESTIC_PASSWORD: ${{ secrets.RESTIC_PASSWORD }}
          # --- R2 ADDITION END ---
        with:
          host: ${{ vars.TS_HOST }}
          username: ${{ vars.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # Added R2 vars to the envs list
          envs: RCON_PASSWORD,GRAFANA_PASSWORD,MC_OPS,MC_WHITELIST,R2_ACCESS_KEY_ID,R2_SECRET_ACCESS_KEY,R2_ENDPOINT,RESTIC_PASSWORD
          script: |
            # Explicitly export the docker host for the non-interactive shell
            export DOCKER_HOST=unix:///run/user/$(id -u)/docker.sock
            export PATH=/home/$HOME/bin:$PATH

            mkdir -p $HOME/app
            cd $HOME/app

            if docker compose ps --services --filter "status=running" | grep -q "minecraft-service"; then
              echo "Minecraft server is running. Sending restart notifications..."

              # Send a big title on screen
              docker compose exec -T minecraft-service rcon-cli "title @a title {\"text\":\"Update Incoming!\", \"color\":\"red\"}"
              docker compose exec -T minecraft-service rcon-cli "title @a subtitle {\"text\":\"Server might restart in 30s\", \"color\":\"yellow\"}"

              # Send chat message
              docker compose exec -T minecraft-service rcon-cli "say §cServer is updating and might restart in 30 seconds."
              sleep 20

              # Final countdown
              docker compose exec -T minecraft-service rcon-cli "say §cServer might restart in 10 seconds!"
              docker compose exec -T minecraft-service rcon-cli "title @a title {\"text\":\"Attempting to restart!\", \"color\":\"red\"}"
              sleep 10

              # Force a save just in case
              docker compose exec -T minecraft-service rcon-cli "save-all"
              docker compose exec -T minecraft-service rcon-cli "say §cIf nothing happens, minecraft service was not affected by the update and it wont restart"
            else
              echo "Server is not running. Skipping notifications."
            fi

            # Generate .env file
            : > .env
            printf "TS_IP=%s\n" "$(/usr/bin/tailscale ip -4)" >> .env
            printf "DOCKER_UID=%s\n" "$(id -u)" >> .env
            printf "DOCKER_GID=%s\n" "$(id -g)" >> .env
            printf "USERNAME=%s\n" "$(whoami)" >> .env
            printf "RCON_PASSWORD=%s\n" "$RCON_PASSWORD" >> .env
            printf "GRAFANA_PASSWORD=%s\n" "$GRAFANA_PASSWORD" >> .env
            printf "MC_OPS=%s\n" "$MC_OPS" >> .env
            printf "MC_WHITELIST=%s\n" "$MC_WHITELIST" >> .env
            # --- R2 ADDITION START ---
            printf "R2_ACCESS_KEY_ID=%s\n" "$R2_ACCESS_KEY_ID" >> .env
            printf "R2_SECRET_ACCESS_KEY=%s\n" "$R2_SECRET_ACCESS_KEY" >> .env
            printf "R2_ENDPOINT=%s\n" "$R2_ENDPOINT" >> .env
            printf "RESTIC_PASSWORD='%s'\n" "$RESTIC_PASSWORD" >> .env
            # --- R2 ADDITION END ---
            chmod 600 .env

            # Deploy
            docker compose pull

            # echo "Clearing Restic zombie locks before deployment..."
            # docker compose run --rm -e INITIAL_DELAY=0s backups restic unlock --remove-all || echo "No locks to clear."

            # Might want to remove --force-recreate if working on other parts of thes server stack
            docker compose up -d --remove-orphans
            docker system prune -f

            # TODO: post deployment message -> move to shellscript?

            sleep 10
            if docker compose ps --services --filter "status=running" | grep -q "minecraft-service"; then
              echo "Server is up! Sending welcome back message."

              docker compose exec -T minecraft-service rcon-cli "title @a clear"
              docker compose exec -T minecraft-service rcon-cli "playsound entity.player.levelup master @a"
              docker compose exec -T minecraft-service rcon-cli "say §aDeployment complete! Server is stable."
              docker compose exec -T minecraft-service rcon-cli "title @a actionbar {\"text\":\"§aSystem Update Complete\", \"bold\":true}"
            else 
              echo "Server not restarted yet, skipping notifications"
            fi
